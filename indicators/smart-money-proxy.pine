//@version=6
indicator("Stella's Smart Money Proxy", overlay=true, max_labels_count=50)

// ============================================
// æ¦‚è¦
// ============================================
// å¤§å£ï¼ˆSmart Moneyï¼‰ã®å‹•å‘ã‚’ä¾¡æ ¼/ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‹ã‚‰æ¨å®š
// â€» å®Ÿéš›ã®ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ä½¿ç”¨ã§ããªã„ãŸã‚ã€
//    å¤§é™½ç·š/å¤§é™°ç·š + é«˜ãƒœãƒªãƒ¥ãƒ¼ãƒ  ã§æ¨å®š

// ============================================
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼è¨­å®š
// ============================================
// ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºåˆ¤å®š
bodyMultiplier = input.float(1.5, "å¤§å£åˆ¤å®š: å¹³å‡ãƒœãƒ‡ã‚£å€ç‡", minval=1.0, maxval=3.0, step=0.1)

// ãƒœãƒªãƒ¥ãƒ¼ãƒ åˆ¤å®š
useVolumeFilter = input.bool(true, "ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨")
volumeMultiplier = input.float(1.5, "ãƒœãƒªãƒ¥ãƒ¼ãƒ å€ç‡", minval=1.0, maxval=5.0, step=0.1)
volumeLookback = input.int(20, "ãƒœãƒªãƒ¥ãƒ¼ãƒ å¹³å‡æœŸé–“", minval=5, maxval=100)

// è¡¨ç¤º
showLabels = input.bool(true, "ã‚·ã‚°ãƒŠãƒ«ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º")
showBox = input.bool(true, "ç´¯ç©ã‚¾ãƒ¼ãƒ³ã‚’è¡¨ç¤º")

// ============================================
// è¨ˆç®—
// ============================================
// ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚º
body = math.abs(close - open)
avgBody = ta.sma(body, 20)

// å¤§å£æ¡ä»¶
isBigBody = body > avgBody * bodyMultiplier
isBullish = close > open
isBearish = close < open

// ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¡ä»¶
avgVolume = ta.sma(volume, volumeLookback)
isHighVolume = volume > avgVolume * volumeMultiplier
volumeCondition = useVolumeFilter ? isHighVolume : true

// Smart Moneyåˆ¤å®š
smartBuy = isBigBody and isBullish and volumeCondition
smartSell = isBigBody and isBearish and volumeCondition

// ============================================
// ç´¯ç©è¿½è·¡
// ============================================
var float accumulationStart = na
var float accumulationEnd = na
var int accumulationBars = 0

// ç´¯ç©é–‹å§‹ï¼ˆé€£ç¶šã—ãŸè²·ã„ï¼‰
if smartBuy and not smartBuy[1]
    accumulationStart := low
    accumulationBars := 1

if smartBuy and smartBuy[1]
    accumulationStart := math.min(accumulationStart, low)
    accumulationBars += 1
    accumulationEnd := high

// ç´¯ç©çµ‚äº†
if not smartBuy and accumulationBars > 0
    accumulationBars := 0
    accumulationStart := na
    accumulationEnd := na

// ============================================
// è¡¨ç¤º
// ============================================
// ã‚·ã‚°ãƒŠãƒ«ãƒ©ãƒ™ãƒ«
if showLabels and smartBuy
    label.new(bar_index, low, "ğŸ‹ BUY", 
              color=color.new(color.green, 70), textcolor=color.white, 
              style=label.style_label_up, size=size.small)

if showLabels and smartSell
    label.new(bar_index, high, "ğŸ‹ SELL", 
              color=color.new(color.red, 70), textcolor=color.white, 
              style=label.style_label_down, size=size.small)

// ç´¯ç©ã‚¾ãƒ¼ãƒ³
showAccumulation = showBox and accumulationBars >= 2
bgcolor(showAccumulation ? color.new(color.green, 92) : na)

// ç´¯ç©ã‚¾ãƒ¼ãƒ³ã®ãƒœãƒƒã‚¯ã‚¹
if showAccumulation and barstate.islast
    box.new(bar_index - accumulationBars + 1, accumulationStart, bar_index, accumulationEnd, 
            bgcolor=color.new(color.green, 90), border_color=color.green)

// ============================================
// ã‚¢ãƒ©ãƒ¼ãƒˆ
// ============================================
alertcondition(smartBuy, "Smart Money è²·ã„", "Smart Moneyã®è²·ã„ã‚·ã‚°ãƒŠãƒ«æ¤œå‡º")
alertcondition(smartSell, "Smart Money å£²ã‚Š", "Smart Moneyã®å£²ã‚Šã‚·ã‚°ãƒŠãƒ«æ¤œå‡º")

// ============================================
// ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼å€¤ï¼ˆã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ç”¨ï¼‰
// ============================================
// ä»–ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«å…¬é–‹
plot(smartBuy ? 1 : smartSell ? -1 : 0, "Smart Money Signal", display=display.none)
