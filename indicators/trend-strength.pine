//@version=6
indicator("Stella's Trend Strength", overlay=false, max_labels_count=50)

// ============================================
// 概要
// ============================================
// 複数の指標を組み合わせてトレンドの強さを0-100で表示
// - ADX（トレンド強度）
// - EMA傾き（方向）
// - RSI（モメンタム）

// ============================================
// パラメーター設定
// ============================================
// ADX設定
adxLength = input.int(14, "ADX期間", minval=1, maxval=50)
adxThreshold = input.int(25, "トレンド判定閾値", minval=10, maxval=40)

// EMA設定
emaFastLength = input.int(20, "短期EMA期間", minval=5, maxval=100)
emaSlowLength = input.int(50, "長期EMA期間", minval=10, maxval=200)

// RSI設定
rsiLength = input.int(14, "RSI期間", minval=1, maxval=50)

// 表示
showSignals = input.bool(true, "シグナルを表示")
showBackground = input.bool(true, "トレンド背景を表示")

// ============================================
// 計算
// ============================================
// ADX
[diplus, diminus, adx] = ta.dmi(adxLength, adxLength)

// EMA
emaFast = ta.ema(close, emaFastLength)
emaSlow = ta.ema(close, emaSlowLength)

// EMA傾き
emaSlope = (emaFast - emaFast[1]) / emaFast[1] * 100
emaSlopeNormalized = math.min(100, math.max(0, (emaSlope + 2) / 4 * 100)) // -2%~+2% を 0~100に正規化

// RSI
rsi = ta.rsi(close, rsiLength)

// トレンド方向
isUptrend = emaFast > emaSlow
isDowntrend = emaFast < emaSlow

// ============================================
// トレンド強度スコア（0-100）
// ============================================
// 構成:
// - ADX（重み40%）: トレンドの強さ
// - EMA Slope（重み30%）: トレンドの方向と勢い
// - RSI（重み30%）: モメンタム

adxScore = math.min(100, adx / 50 * 100) // ADX 50を100点とする
slopeScore = emaSlopeNormalized
rsiScore = rsi

trendStrength = (adxScore * 0.4) + (slopeScore * 0.3) + (rsiScore * 0.3)

// 買い/売り調整
bullStrength = isUptrend ? trendStrength : 0
bearStrength = isDowntrend ? trendStrength : 0

// ============================================
// 表示
// ============================================
// メインゲージ（ヒストグラム）
plot(trendStrength, "Trend Strength", color=isUptrend ? color.green : color.red, linewidth=2, style=plot.style_columns)

// ADXライン
plot(adx, "ADX", color=color.blue, linewidth=1)
hline(adxThreshold, "ADX閾値", color=color.gray, linestyle=hline.style_dashed)

// レベル
hline(70, "強い", color=color.green, linestyle=hline.style_dotted)
hline(30, "弱い", color=color.red, linestyle=hline.style_dotted)
hline(50, "中立", color=color.gray, linestyle=hline.style_dotted)

// 背景
bgcolor(showBackground and trendStrength > 70 and isUptrend ? color.new(color.green, 90) : 
        showBackground and trendStrength > 70 and isDowntrend ? color.new(color.red, 90) : na)

// ============================================
// シグナル
// ============================================
// 強いトレンド開始
strongBull = trendStrength > 70 and isUptrend and trendStrength[1] <= 70
strongBear = trendStrength > 70 and isDowntrend and trendStrength[1] <= 70

// トレンド終了
trendEnd = trendStrength < 30 and trendStrength[1] >= 30

plotshape(showSignals and strongBull, "Strong Bull", shape.triangleup, location.bottom, color.green, size=size.small)
plotshape(showSignals and strongBear, "Strong Bear", shape.triangledown, location.top, color.red, size=size.small)
plotshape(showSignals and trendEnd, "Trend End", shape.circle, location.bottom, color.orange, size=size.small)

// ============================================
// アラート
// ============================================
alertcondition(strongBull, "強気トレンド開始", "強気トレンドが始まりました")
alertcondition(strongBear, "弱気トレンド開始", "弱気トレンドが始まりました")
alertcondition(trendEnd, "トレンド終了", "トレンドが弱まりました")

// ============================================
// 情報パネル
// ============================================
var table panel = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 90), border_width=1)

if barstate.islast
    table.cell(panel, 0, 0, "トレンド強度", text_color=color.white, text_size=size.small)
    table.cell(panel, 1, 0, str.tostring(trendStrength, "#.#"), 
               text_color=trendStrength > 70 ? color.green : trendStrength < 30 ? color.red : color.white, 
               text_size=size.small)
    table.cell(panel, 0, 1, "ADX", text_color=color.white, text_size=size.small)
    table.cell(panel, 1, 1, str.tostring(adx, "#.#"), text_color=color.blue, text_size=size.small)
    table.cell(panel, 0, 2, "方向", text_color=color.white, text_size=size.small)
    table.cell(panel, 1, 2, isUptrend ? "↑ 上昇" : "↓ 下降", 
               text_color=isUptrend ? color.green : color.red, text_size=size.small)
    table.cell(panel, 0, 3, "判定", text_color=color.white, text_size=size.small)
    table.cell(panel, 1, 3, adx > adxThreshold and trendStrength > 50 ? "トレンド" : "レンジ", 
               text_color=adx > adxThreshold ? color.green : color.orange, text_size=size.small)
