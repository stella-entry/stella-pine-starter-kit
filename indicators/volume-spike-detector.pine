//@version=6
indicator("Stella's Volume Spike Detector", overlay=true, max_labels_count=500)

// ============================================
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼è¨­å®š
// ============================================
lookbackPeriod = input.int(20, "ãƒ«ãƒƒã‚¯ãƒãƒƒã‚¯æœŸé–“", minval=5, maxval=100)
spikeMultiplier = input.float(2.0, "æ€¥å¢—åˆ¤å®šå€çŽ‡", minval=1.0, maxval=5.0, step=0.1)

// è¡¨ç¤ºè¨­å®š
showLabels = input.bool(true, "ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º")
showBackground = input.bool(true, "èƒŒæ™¯è‰²ã‚’è¡¨ç¤º")

// è‰²
bullishColor = input.color(color.new(color.green, 0))
bearishColor = input.color(color.new(color.red, 0))

// ============================================
// ãƒœãƒªãƒ¥ãƒ¼ãƒ è¨ˆç®—
// ============================================
avgVolume = ta.sma(volume, lookbackPeriod)
isSpike = volume > avgVolume * spikeMultiplier

// ä¾¡æ ¼æ–¹å‘
isBullish = close > open
isBearish = close < open

// ã‚¹ãƒ‘ã‚¤ã‚¯ã‚¿ã‚¤ãƒ—
bullishSpike = isSpike and isBullish
bearishSpike = isSpike and isBearish

// ============================================
// è¡¨ç¤º
// ============================================
// èƒŒæ™¯è‰²
bgcolor(showBackground and bullishSpike ? color.new(color.green, 85) : showBackground and bearishSpike ? color.new(color.red, 85) : na)

// ãƒ©ãƒ™ãƒ«
if showLabels and bullishSpike
    label.new(bar_index, high, "ðŸŸ¢ VOL x" + str.tostring(volume / avgVolume, "#.#"), 
              color=color.new(color.green, 80), textcolor=color.white, 
              style=label.style_label_down, size=size.tiny)

if showLabels and bearishSpike
    label.new(bar_index, low, "ðŸ”´ VOL x" + str.tostring(volume / avgVolume, "#.#"), 
              color=color.new(color.red, 80), textcolor=color.white, 
              style=label.style_label_up, size=size.tiny)

// ============================================
// ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶
// ============================================
alertcondition(bullishSpike, "è²·ã„ãƒœãƒªãƒ¥ãƒ¼ãƒ æ€¥å¢—", "è²·ã„ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¹³å‡ã®{{ticker}}å€ã«æ€¥å¢—")
alertcondition(bearishSpike, "å£²ã‚Šãƒœãƒªãƒ¥ãƒ¼ãƒ æ€¥å¢—", "å£²ã‚Šãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¹³å‡ã®{{ticker}}å€ã«æ€¥å¢—")
alertcondition(isSpike, "ãƒœãƒªãƒ¥ãƒ¼ãƒ æ€¥å¢—", "ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¹³å‡ã®{{ticker}}å€ã«æ€¥å¢—")

// ============================================
// æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
// ============================================
var table infoPanel = table.new(position.top_right, 2, 3, bgcolor=color.new(color.black, 90), border_width=1)

if barstate.islast
    table.cell(infoPanel, 0, 0, "å¹³å‡ãƒœãƒªãƒ¥ãƒ¼ãƒ ", text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 1, 0, str.tostring(avgVolume, "#,###"), text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 0, 1, "ç¾åœ¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ", text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 1, 1, str.tostring(volume, "#,###"), text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 0, 2, "å€çŽ‡", text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 1, 2, str.tostring(volume / avgVolume, "#.#") + "x", 
               text_color=isSpike ? color.green : color.white, text_size=size.small)
